{% extends 'layout.html' %}
{% block content %}

{% from 'bits.html' import breadcrumb_items -%}
<ul class="breadcrumb">
  {{ breadcrumb_items([
      (url_for('goals.admin'), "Admin"),
      (url_for('goals.mapping'), "Mapping"),
      (url_for('goals.mapping_edit'), "Edit")
      ]) }}
</ul>

{% from "navigation.html" import nav_tabs %}
{{ nav_tabs('mapping') }}

<h1>Map National Objectives to Aichi targets</h1>

<form class="form" method="POST" action="{{url_for('goals.mapping_edit', mapping_id=mapping_id)}}" style="margin-top: 25px">
  <fieldset>

  {%- for name in mk.children_order(mapping_schema) %}

    {% set field = mapping_schema[name] %}
    {% set error_cls = 'error' if field.errors else '' %}

    {% if field.properties.widget != 'hidden' %}
    <div class="control-group {{ error_cls }} row">
      <label class="control-label span2" for="{{field.name}}">{{ field.label }}</label>
      <div class="controls span3">
        {{ mk.widget(field) }}
        {% for message in field.errors %}
          <span class="help-inline">{{ message }}</span>
        {% endfor %}
      </div>
      <div class="mapping_text span7 {{field.name}}"></div>
    </div>
    {% endif %}

  {% endfor -%}

  </fieldset>
  <div class="form-actions">
    <button type="submit" class="btn btn-primary">Save</button>
    {% if mapping_id %}
     <a class="btn btn-danger" href="{{ url_for('goals.mapping_delete', mapping_id=mapping_id) }}">
       Delete
     </a>
    {% endif %}
    <a class="btn" href="{{ url_for('goals.mapping') }}">Cancel</a>
  </div>
</form>

{% endblock content %}
{% block scripts %}
  {{ super() }}

  {% from 'bits.html' import script_src -%}
  {{script_src('js/jquery.chained.mini.js')}}
  {{script_src('js/mustache.js')}}

  <script>
  $('.chzn-select').attr('data-placeholder', 'Select targets');
  $(function () {

    $('select[name=objective]').on('change', function () {
      var option = $(this).val();
      var text = $(this).parents('.control-group').find('.mapping_text');
      $.get("{{url_for('objectives.objective_data')}}", {'id_code': option}, function (data) {
        text.html('<p>' + data['result'] + '</p>');
      });
    }).change();

    $('select[name=goal]').on('change', function () {
      var option = $(this).val();
      var text = $(this).parents('.control-group').find('.mapping_text');
      $.get("{{url_for('goals.goal_data')}}", {'goal_short_title': option}, function (data) {
        text.html('<p>' + data['result'] + '</p>');
      });
    }).change();

    $('select[name=main_target]').on('change', function () {
      var option = $(this).val();
      var text = $(this).parents('.control-group').find('.mapping_text');
      $.get("{{url_for('targets.target_data')}}", {'other_targets': option}, function (data) {
        text.html('<p>' + data['result'][0]['description'] + '</p>');
      });
    }).change();

    $('select[name=other_targets]').on('change', function () {
      var options = $(this).serialize();
      var text = $(this).parents('.control-group').find('.mapping_text');
      $.get("{{url_for('targets.target_data')}}", options, function (data) {
        var html_content = "{% raw %}{{#result}}<h5>{{title}}</h5><p>{{description}}</p>{{/result}}{% endraw %}"
        var output = Mustache.render(html_content, data)
        text.html(output);
      });
    });

    $("#main_target").chained("#goal");

    $(".btn-danger").on("click", function (e) {
      e.preventDefault();
      if(confirm("Are you sure you want to delete this mapping?")) {
        $.ajax({
          "url": $(this).attr("href"),
          "type": "DELETE",
          "success": function (data) {
            if(data.status == "success") window.location = "/admin/mapping";
          }
        });
      }
    });

  });
  </script>
{% endblock scripts %}
